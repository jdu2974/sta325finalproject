---
title: "NFL Plays"
output:
  pdf_document: default
  html_document: default
date: "2023-12-04"
---

```{r data, include=FALSE}
library(nflverse)
library(tidyverse)
library(readr)
library(ggplot2)
library(patchwork)
library(chron)
library(lubridate)
library(broom)
library(knitr)
library(xgboost)
library(mltools)
library(data.table)


pbp <- load_pbp(2018:2020)
pbp$time_of_day  <- strptime(paste("2001-01-01", pbp$time_of_day ), format="%Y-%m-%d %H:%M")
pbp$time_of_day <- format(round(pbp$time_of_day, units="hours"), format="%H:%M")
pbp$time_of_day <- ((as.numeric(substr(pbp$time_of_day, 1, 2)) - 5) +24) %% 24
pbp$time_of_day <- paste0(pbp$time_of_day, ":00")
pbp$time_of_day[grepl("NA", pbp$time_of_day)] <- NA

weather <- read_csv("weather.csv")
weather$date <- as.Date(gsub( " .*$", "", weather$TimeMeasure ),  format = "%m/%d/%Y")
weather_clean <- weather %>%
  filter(date>= as.Date("2018-09-06")) %>%
  filter(grepl("^.+(00)$", TimeMeasure))
weather_clean$TimeMeasure <- word(weather_clean$TimeMeasure,-1)
colnames(weather_clean)[colnames(weather_clean) == "game_id"] <- "old_game_id"
colnames(weather_clean)[colnames(weather_clean) == "TimeMeasure"] <- "time_of_day"
weather_clean$old_game_id <- as.character(weather_clean$old_game_id)

merged_df <- merge(pbp, weather_clean, by=c("old_game_id","time_of_day")) %>%
  filter(!is.na(down))

training_nf_data <- merged_df %>%
  filter(season == 2018 | season == 2019) %>%
  filter(down != 4)

training_f_data <- merged_df %>%
  filter(season == 2018 | season == 2019) %>%
  filter(down == 4)

test_nf_data <- merged_df %>%
  filter(season == 2020) %>%
  filter(down != 4)

test_f_data <- merged_df %>%
  filter(season == 2020) %>%
  filter(down == 4)

```


# Data Description

We use two datasets in our analysis. 

The first dataset, obtained from Kaggle,
consists of hourly weather observations recorded from Meteostat and Weather Underground
for games from the 2000-2001 NFL season to the 2020-2021 NFL season. In total,
there are 37,155 hourly observations. Each observation relevant weather metrics
such as temperature (in Fahrenheit), dew point, humidity (0 - 100), precipitation (mm), 
wind speed (MPH), and estimated condition. The estimated condition is qualitatively
described, with levels such as clear, heavy rain, moderate rain, light rain, light
snow, and moderate snow.

The second dataset, obtained from the nflverse R package, consists of play-by-play 
data for every NFL game since the 1999-2000 NFL season. For our analysis,
we will only use data from the 2018-2019 to 2020-2021 seasons, in order to align
our timeframes with the weather observations dataset. In total, there were 144,422
plays over these three NFL seasons. In addition to play-specific 
characteristics such as down, yard line, time remaining in quarter, score of game,
play type, and result of play, each play also records the home and away team and
the type of stadium in which the game is being played in (outdoors, dome, closed
stadium, and open stadium).

Although the play-by-play dataset does contain variables describing the weather
conditions such as temperature and wind speed, it is play-agnostic and therefore
does not change over the course of the game. This is problematic because we cannot
assume that weather conditions remain constant as the day progresses. Therefore,
we cannot rely solely on the play-by-play dataset and must incorporate the hourly
observations dataset. Both datasets share a common game ID variable and similar
time of day measurements, so after initial data cleaning (rounding the time of day
measurements in the play-by-play dataset to the nearest hour to match the format
of the hourly weather observations, which occur at the start of each hour), we
are able to merge the two datasets, and after filtering out plays that do not have
a specified down (kickoffs, extra points, timeouts), we are left with 112,381 plays
with hourly weather observations.

We will use plays from the 2018-2019 and 2019-2020 seasons as our training set
(67720 non-fourth-down plays and 7576 fourth down plays) and plays from the 2020-2021 season 
(33528 non-fourth-down plays and 3557 fourth down plays) as our test set. This roughly
corresponds to a 2/3 train-test split for both non-fourth-down and fourth down plays.



# Variable Selection

We first analyze non fourth down playcalling, with a particular emphasis on deciding
whether to run or pass. After filtering our non fourth down training dataset to only
include plays with these outcomes, we are left with 62,251 run or pass plays.
As there are 

```{r}
boosting_nf_train <- training_nf_data %>%
  filter(play_type == "pass" | play_type == "run")

relevant_cols <- c("yardline_100", "quarter_seconds_remaining", "half_seconds_remaining",
                  "game_seconds_remaining", "drive", "qtr", "down", "goal_to_go", 
                  "total_home_score", "total_away_score", "posteam_score", "defteam_score",
                  "score_differential", "season", "series", "drive_play_count", "drive_first_downs",
                   "Temperature", "DewPoint", "Humidity", "Precipitation", "WindSpeed", "Pressure",
                  "roof", "surface")

boosting_nf_train$roof <- as.factor(boosting_nf_train$roof)
boosting_nf_train$surface <- as.factor(boosting_nf_train$surface)

one_hot <- one_hot(setDT(boosting_nf_train[, relevant_cols]) )



xgboost_train = xgb.DMatrix(data= as.matrix(one_hot), label= as.factor(boosting_nf_train$play_type))


xgboost_nf <- xgboost(data = xgboost_train,                    # the data   
                 max.depth= 10,                          # max depth 
                 nrounds=100)

xgb.importance(colnames(one_hot), model = xgboost_nf)


```


## EDA

First, we consider  playcalling on first, second, and third downs versus fourth
downs. We first display the number of occurrences of each play type among non-fourth
down plays versus fourth down plays.

```{r}
freq_nf <- as.data.frame(table(training_nf_data$play_type))
freq_nf$Var1 <- c("Field Goal", "No Play", "Pass", "QB Kneel", "QB Spike", "Run")
colnames(freq_nf) <- c("Play Type", "Frequency")
freq_nf %>%
  kable(digits = 3)

freq_f <- as.data.frame(table(training_f_data$play_type))
freq_f$Var1 <- c("Field Goal", "No Play", "Pass", "Punt", "QB Kneel", "Run")
colnames(freq_f) <- c("Play Type", "Frequency")
freq_f %>%
  kable(digits = 3)
```

As expected, coaches will never punt and only kick field goals near the end
of a half on non fourth downs, while prioritizing punts and field goals on fourth
down.


```{r, echo = FALSE, fig.height = 7.5, fig.width = 16}
p1 <- ggplot(data = weather_train %>% filter(!is.na(EstimatedCondition)), aes(x = EstimatedCondition, y= Temperature)) +
  geom_boxplot() +
  theme_bw() +
  labs(x = "Condition")


p1 + plot_annotation(title = 'Distribution of Temperature Based on Weather Condition', theme = theme(plot.title = element_text(hjust = 0.5, size = 30)))

fourth_down <- pbp %>%
  filter(down == 4) %>%
  group_by(play_type, roof) %>%
  summarize(count = n()) %>%
  filter(!(is.na(play_type))) %>%
  filter(!(play_type == "no_play"))

p2 <- ggplot(data = fourth_down, aes(fill = play_type, x = roof, y = count)) + geom_bar(position="fill", stat="identity") +
  labs(x = "Type of Stadium", y = "Percentage")

p2 + plot_annotation(title = 'Distribution of 4th Down Plays Based on Type of Stadium', theme = theme(plot.title = element_text(hjust = 0.5, size = 30)))
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
